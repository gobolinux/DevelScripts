#!/bin/sh

### Imports ###################################################################

source ScriptFunctions
Import GoboLinux
Import File
Import Subversion
Import OptionParser

### Options ###################################################################

scriptDescription="Upload recipes to the recipe store."
scriptCredits="Copyright (C) 2006 Andre Detsch, Lucas C. Villa Real. Released under the GNU GPL."
helpOnNoArguments=yes
scriptUsage="<program names...>"
scriptExample="GoboHide"
Add_Option_Boolean "a" "all" "Uploads all recipes in the local revision tree."
Parse_Options "$@"

Parse_Conf CompileSubversion.conf

### Operation #################################################################

unset tarballs

function update_recipe() {
   if echo $1 | grep -q ".tar.bz2$"
   then program="`echo $1 | sed 's,\(.*\)--\(.*\)--.*,\1,g'`"
   else program="$1"
   fi

   Quiet pushd "$compileLocalRevisions"
   [ "$program" ] && program=`ls | grep -i "^$program$"`
   if ! [ "$program" ]
   then
      echo "Skipping $1. Please use PutGobo to commit this recipe in the svn tree!"
      continue
   fi

   if [ `svn diff $program | wc -l | awk {'print $1'}` -ne 0 ]
   then
      svn up $program
   fi

   if [ "$program" ]
   then files=$program/*
   else files=*/*
   fi

   for i in $files
   do
      tarball=/Files/Recipe-Store/`echo $i | sed 's,\(.*\)\/\(.*\),\1--\2--recipe.tar.bz2,g'`
      [ -e "$tarball" ] && continue || echo $tarball
      tarballs="$tarballs $tarball"
      tar cfj "$tarball" --exclude .svn $i
   done
   Quiet popd
}

mkdir -p /Files/Recipe-Store
rsync --delete -avz gobolinux@gobolinux.org:gobolinux.org/recipe-store/ /Files/Recipe-Store/

if Boolean "all"
then recipes=( `ls $compileLocalTrunk` )
else eval `Args_To_Array recipes`
fi

# Loop 1: create tarballs not yet generated.
for i in ${recipes[@]}
do
   update_recipe "$i"
done
   
# Loop 2: remove revision tarballs which doesn't exist anymore in the svn.
cd /Files/Recipe-Store
for i in *
do
    svn_dir=$compileLocalRevisions/`echo $i | sed 's,\(.*\)--\(.*\)--recipe.tar.bz2,\1/\2,g'`
    [ -d "$svn_dir" ] || { echo $i; rm $i; }; 
done

\ls | grep recipe.tar.bz2 > MANIFEST
bzip2 -f -k MANIFEST
tarballs="$tarballs MANIFEST MANIFEST.bz2"

if Boolean "all"
then rsync --delete -avz ./ gobolinux@gobolinux.org:gobolinux.org/recipe-store/
else rsync -avz $tarballs gobolinux@gobolinux.org:gobolinux.org/recipe-store/
fi

# Update the RSS on the front page.
wget -nv http://gobolinux.org/tools/updaterecipe.php -O /dev/null
