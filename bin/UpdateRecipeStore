#!/bin/sh

### Imports ###################################################################

source ScriptFunctions
Import GoboLinux
Import File
Import Subversion
Import OptionParser

### Options ###################################################################

scriptDescription="Upload recipes to the recipe store."
scriptCredits="Copyright (C) 2006 Andre Detsch, Lucas C. Villa Real. Released under the GNU GPL."
helpOnNoArguments=yes
scriptUsage="<program name>"
scriptExample="GoboHide"
Add_Option_Boolean "a" "all" "Uploads all recipes in the local revision tree."
Parse_Options "$@"

Parse_Conf CompileSubversion.conf

### Operation #################################################################

mkdir -p /Files/Recipe-Store
rsync --delete -avz gobolinux@gobolinux.org:gobolinux.org/recipe-store /Files/Recipe-Store/

# Loop 1: create tarballs not yet generated
cd "$compileLocalRevisions"
program="$(Arg 1)"
[ "$program" ] && program=`ls | grep -i "^$program$"`
svn up $program

if [ "$program" ]
then files=$program/*
else files=*/*
fi

unset tarballs
for i in $files
do
   tarball=/Files/Recipe-Store/`echo $i | sed 's,\(.*\)\/\(.*\),\1--\2--recipe.tar.bz2,g'`
   [ -e "$tarball" ] && continue || echo $tarball
   tarballs="$tarballs $tarball"
   tar cfj "$tarball" --exclude .svn $i
done

# Loop 2: remove revision tarballs which doesn't exist no more in the svn.
cd /Files/Recipe-Store
for i in *
do
   svn_dir=$compileLocalRevisions/`echo $i | sed 's,\(.*\)--\(.*\)--recipe.tar.bz2,\1/\2,g'`
   [ -d "$svn_dir" ] || { echo $i; rm $i; };
done

\ls | grep recipe.tar.bz2 > MANIFEST
bzip2 -f -k MANIFEST
tarballs="$tarballs MANIFEST MANIFEST.bz2"

if [ "$program" ]
then rsync -avz $tarballs gobolinux@gobolinux.org:gobolinux.org/recipe-store
elif Boolean "all"
then rsync --delete -avz ./ gobolinux@gobolinux.org:gobolinux.org/recipe-store
fi
