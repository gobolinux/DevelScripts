#!/bin/sh

### Imports ###################################################################

source ScriptFunctions
Import GoboLinux
Import File
Import Subversion
Import OptionParser

### Options ###################################################################

scriptDescription="Update a local store based on svn repository."
scriptCredits="Copyright (C) 2007 Hisham Muhammad. Released under the GNU GPL."
scriptUsage=""
scriptExample=""
Add_Option_Boolean "U" "skip-update" "Do not resync svn tree with 'svn up'"

Parse_Options "$@"

Parse_Conf CompileSubversion.conf

###############################################################################

mkdir -p $compileLocalStore

cd $compileLocalRevisions
if ! Boolean "skip-update"
then
   svn up
fi

\ls | while read program
do
   cd "$compileLocalRevisions/$program"
   \ls | while read version
   do
      revision=${version#*-r}
      justversion=${version%-r*}
      recipe="$compileLocalStore/$program--$version--recipe.tar.bz2"
      if [ -e "$compileLocalRevisions/$program/$justversion-r$[revision+1]" ]
      then 
         rm -f "$recipe"
      elif [ ! -e "$recipe" ]
      then
         cd $compileLocalRevisions
         tar cjpf "$recipe" --exclude .svn "$program/$version"
      fi
   done
done

cd $compileLocalStore
rm MANIFEST MANIFEST.bz2 RecipeList
ls | grep ".*--recipe.*" > MANIFEST
cp MANIFEST RecipeList
bzip2 --keep MANIFEST

