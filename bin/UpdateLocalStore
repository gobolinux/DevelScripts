#!/bin/sh
export HOME=/home/gobolinux

### Imports ###################################################################

source ScriptFunctions
Import GoboLinux
Import File
Import Subversion
Import OptionParser

### Options ###################################################################

scriptDescription="Update a local store based on svn repository."
scriptCredits="Copyright (C) 2007 Hisham Muhammad. Released under the GNU GPL."
scriptUsage=""
scriptExample=""
Add_Option_Boolean "U" "skip-update" "Do not resync svn tree with 'svn up'"

Parse_Options "$@"

Parse_Conf CompileSubversion.conf

###############################################################################

echo `date` Started >> ~/cronlog.txt

remove_slash() {
   sed 's,/$,,'
}

compileLocalRepoRevisions="file:///home/gobolinux/svn/recipes/revisions"

mkdir -p $compileLocalStore

packdir=`Temporary_Dir`

svn list "$compileLocalRepoRevisions" | remove_slash | while read program
do
   unset prevversion
   unset prevrecipe   
   for version in `svn list "$compileLocalRepoRevisions/$program" | remove_slash | LC_ALL=C sort -r`
   do
      revision=${version#*-r}
      justversion=${version%-r*}
      recipe="$compileLocalStore/$program--$version--recipe.tar.bz2"
      if [ "$justversion" = "$prevversion" ]
      then 
         rm -f "$recipe"
      elif [ ! -e "$recipe" ]
      then
         Quiet pushd "$packdir"
         mkdir "$program"
         svn checkout "$compileLocalRepoRevisions/$program/$version" "$program/$version"
         tar cjpf "$recipe" --exclude .svn "$program/$version"
         Log_Normal "Packed $recipe"
         Quiet popd
      fi
      prevversion="$justversion"
   done
done

rm -rf "$packdir"

cd $compileLocalStore
rm MANIFEST MANIFEST.bz2 RecipeList
ls | grep ".*--recipe.*" > MANIFEST
cp MANIFEST RecipeList
bzip2 --keep MANIFEST

echo `date` Finished >> ~/cronlog.txt
