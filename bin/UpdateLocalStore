#!/bin/sh
export CPLUS_INCLUDE_PATH=/home/gobolinux/Rootless/System/Links/Headers
export C_INCLUDE_PATH=/home/gobolinux/Rootless/System/Links/Headers
export HOME=/home/gobolinux
export HOST=oakdale
export INFOPATH=/home/gobolinux/Rootless/System/Links/Manuals/info:
export LANG=C
export LANGUAGE=C
#en_US:en_GB:en
export LD_LIBRARY_PATH=/home/gobolinux/Rootless/System/Links/Libraries:
export LOGNAME=gobolinux
export PATH=/home/gobolinux/Rootless/System/Links/Executables:/home/gobolinux/Rootless/System/Links/Executables:/usr/local/bin:/bin:/usr/bin:/usr/X11R6/bin:.:.
export PYTHONPATH=/home/gobolinux/Rootless/System/Links/Libraries/python2.3/site-packages:/home/gobolinux/Rootless/System/Links/Libraries/python2.4/site-packages:
export ROOTLESS_GOBOLINUX=1
export SHELL=/bin/zsh
export TERM=xterm-color
export TMPDIR=/home/gobolinux/Rootless/System/Variable/tmp
export USER=gobolinux
export USERNAME=gobolinux
export goboPrefix=/home/gobolinux/Rootless

### Imports ###################################################################

source ScriptFunctions
Import GoboLinux
Import File
Import Subversion
Import OptionParser

### Options ###################################################################

scriptDescription="Update a local store based on svn repository."
scriptCredits="Copyright (C) 2007 Hisham Muhammad. Released under the GNU GPL."
scriptUsage=""
scriptExample=""
Add_Option_Boolean "U" "skip-update" "Do not resync svn tree with 'svn up'"

Parse_Options "$@"

Parse_Conf CompileSubversion.conf

###############################################################################

echo `date` Started >> ~/cronlog.txt

remove_slash() {
   sed 's,/$,,'
}

compileLocalRepoRevisions="file:///home/gobolinux/svn/recipes/revisions"

mkdir -p $compileLocalStore

packdir=`Temporary_Dir`

svn list "$compileLocalRepoRevisions" | grep -i "$(Arg 1)" | remove_slash | while read program
do
   unset prevversion
   unset prevrecipe   
   unset prevjustversion
   versions=(`svn list "$compileLocalRepoRevisions/$program" | remove_slash`)
   [ "$versions" ] || continue
   #for version in `svn list "$compileLocalRepoRevisions/$program" | remove_slash | LC_ALL=C sort -r`
   for version in $(GuessLatest -l "${versions[@]}")
   do
      revision=${version#*-r}
      justversion=${version%-r*}
      recipe="$compileLocalStore/$program--$version--recipe.tar.bz2"
      #if [ "$version" != "$(GuessLatest "$version" "$prevversion")" -a "$prevjustversion" == "$justversion" ]
      if [ "$prevjustversion" == "$justversion" -a "$version" != "$prevversion" ]
      then 
         rm -f "$recipe"
      elif [ ! -e "$recipe" ]
      then
         Quiet pushd "$packdir"
         mkdir "$program"
         svn checkout "$compileLocalRepoRevisions/$program/$version" "$program/$version"
         tar cjpf "$recipe" --exclude .svn "$program/$version"
         Log_Normal "Packed $recipe"
         Quiet popd
      fi
      prevversion="$version"
      prevjustversion="$justversion"
   done
done

rm -rf "$packdir"

cd $compileLocalStore
rm MANIFEST MANIFEST.bz2 RecipeList RecipeList.bz2
ls | grep ".*--recipe.*" > MANIFEST
cp MANIFEST RecipeList
bzip2 --keep MANIFEST
bzip2 --keep RecipeList

echo `date` Finished >> ~/cronlog.txt
wget -O /dev/null -o /dev/null http://www.gobolinux.org/tools/genlatestrecipes.php
