#!/bin/sh

### Imports ###################################################################

source ScriptFunctions
Import GoboLinux
Import OptionParser
source $goboSettings/Compile/Compile.conf
source $goboSettings/Compile/CompileSubversion.conf

### Options ###################################################################

scriptDescription="Put a recipe in the svn trunk/revision tree and upload it to the store."
scriptCredits="Copyright (C) 2007 Lucas C. Villa Real. Released under the GNU GPL."
helpOnNoArguments=yes
scriptUsage="<recipe directory>"
scriptExample="/Files/Compile/LocalRecipes/Firefox"
Add_Option_Boolean "S" "skip-store" "Don't upload to the recipe store"
Parse_Options "$@"

### Operation #################################################################

recipedir=$(Arg 1)
program=`basename $recipedir`

# Ensures that we're not referencing old versions or CVS snapshots of the Compile tool
for i in `find $recipedir -name Recipe`
do
    cat $i | sed 's,compile_version=.*,compile_version=1.8.0,g' > x && mv x $i
done

# Create a tarball and store it at /Files/Compile/PackedRecipes
PackRecipe $program || exit 1

unset hasupdates
for tarball in `ls -t ${compilePackedRecipesDir}/${program}*`
do
    version=`basename $tarball | sed 's,\(.*\)--\(.*\)--.*,\2,g'`

    # Merge the recipe into the local trunk
    ImportRecipe $tarball || exit 1

    Quiet pushd $compileLocalTrunk/$program/$version
    contextlines=`svn diff --non-interactive | wc -l`
    [ $contextlines -eq 0 ] && continue
    Quiet popd

    # Commit the trunk and/or the revision tree.
    PublishRevision --skip-lint $program $version || exit 1
    hasupdates=yes
done

# Copy the recipe to the store
if [ "$hasupdates" ] && ! Boolean "skip-store"
then UpdateRecipeStore $program
fi
