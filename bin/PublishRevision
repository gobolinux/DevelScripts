#!/bin/sh

### Imports ###################################################################

source ScriptFunctions
Import GoboLinux
Import File
Import Subversion
Import OptionParser

### Options ###################################################################

scriptDescription="Publish a revision from the svn trunk to the revisions tree."
scriptCredits="Copyright (C) 2006 Hisham Muhammad. Released under the GNU GPL."
helpOnNoArguments=yes
scriptUsage="<program> [<version>]"
scriptExample="Glibc 2.5"
scriptNotes="If no version is given, all versions in trunk are checked."
#Add_Option_Boolean "b" "bool" "A boolean option."
#Add_Option_Entry "r" "rename" "Rename program to <entry>."
#Add_Option_List "l" "list" "Enter a colon-separated list of..." "foo:bar"
Add_Option_Entry "u" "username"  "User name used for commiting changes at svn server."
Parse_Options "$@"

# Use this to parse attributions from
# ${goboSettings}/Scripts/INSERT_NAME_HERE.conf or
# ${goboUserSettings}/Scripts/INSERT_NAME_HERE.conf 

Parse_Conf CompileSubversion.conf

trunk=`Get_Local_Trunk` || Die "Could not find a valid svn trunk."
revisions=`Get_Local_Revisions` || Die "Could not find a valid svn revisions tree."

username=`Entry username`
[ "$username" ] && username="--username $username" 

### Operation #################################################################

function publish_revision() {
   program="$1"
   version="$2"
   
   if ! [ -d "$revisions/$program" ]
   then
      svn mkdir "$revisions/$program"
   fi
   prefix="$version-r"
   if ls -d "$revisions/$program/$prefix"* &> /dev/null
   then
      latest=`cd "$revisions/$program"
              ls -d "$prefix"* | cut -b$[${#prefix}+1]- | sort -nr | head -n1`
      revision=$[latest+1]
      
      if [ `diff -Nur --exclude .svn "$revisions/$program/$version-r$latest" "$trunk/$program/$version" | wc -l` = 0 ]
      then
         Log_Verbose "There are no differences between the trunk and the latest revision (r$latest)."
         Log_Verbose "Will not publish a new revision for $program $version."
         return
      fi
   else
      revision=1
   fi
   
   if [ `svn status "$trunk/$program/$version" | wc -l` -gt 0 ]
   then
      Log_Normal "Trunk has uncommitted changes for $program $version."
      if Ask "Commit the changes at $trunk/$program?"
      then svn commit $username "$trunk/$program" || Die "Error commiting $trunk/$program"
      else return
      fi
   fi
   
   Log_Normal "Publishing revision: $program $version-r$revision"

   unset publishrecipe
   recipetarball="$goboTemp/$program--$version--recipe.tar.bz2"
   (
      cd "$trunk"
      Verbose tar cjvpf "$recipetarball" --exclude=.svn "$program/$version"
   )
   RecipeLint "$recipetarball"
   recipestatus=$?
   rm "$recipetarball"
   if [ "$recipestatus" -eq 1 ]
   then
      Log_Error "RecipeLint reported warnings in $program $version from trunk."
      if ! Ask "Proceed and publish it anyway?"
      then return
      fi
      publishrecipe=yes
   elif [ "$recipestatus" -eq 2 ]
   then
      Log_Error "RecipeLint reported errors in $program $version from trunk. Not publishing it."
      return
   fi

   svn copy "$trunk/$program/$version" "$revisions/$program/$version-r$revision"
   
   Log_Normal "Listing $revisions/$program/$version-r$revision"
   find $revisions/$program/$version-r$revision | grep -v '\.svn'
   if [ ! "$publishrecipe" ] && ! Ask "Ok to commit revision?"
   then 
      rm -rf $revisions/$program/$version-r$revision
      return
   fi
   
   Log_Normal "Commiting..."
   svn commit $username --message "Commiting revision $revision" $revisions/$program
}

### Operation #################################################################

program="$(basename $(Arg 1))"
version="$(Arg 2)"

programintrunk=`ls "$trunk" | grep -i "^$program$"`
[ "$programintrunk" ] || echo "Could not find $program in trunk."
[ `echo "$programintrunk" | wc -l` -eq 1 ] || Die "More than one capitalization for $program found in trunk. Please check."
program="$programintrunk"

Log_Normal "Updating local subversion copy..."
svn update "$revisions/$program"

if [ "$version" ]
then
   publish_revision "$program" "$version"
else
   for version in `ls "$trunk/$program"`
   do
      publish_revision "$program" $(basename "$version")
   done
fi
